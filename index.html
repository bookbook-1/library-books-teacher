<script>
        // â–¼â–¼â–¼ ì—¬ê¸°ì— ë³¸ì¸ì˜ 'ì›¹ì— ê²Œì‹œ'ëœ CSV ì£¼ì†Œë¥¼ ì •í™•íˆ ë„£ì–´ì£¼ì„¸ìš” â–¼â–¼â–¼
        const sheetCsvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQvgpFiJL5vGTUdZk3u_cnRyXeZ-Ej5u_FC3HihBMHtHs17ZBSObgQe6aWDH3UFIHpu0oKy1TYhcKPP/pub?gid=0&single=true&output=csv"; 
        // ì£¼ì˜: ëì´ /edit ê°€ ì•„ë‹ˆë¼ /pub?output=csv ì—¬ì•¼ í•©ë‹ˆë‹¤!

        // --- ì—¬ê¸°ì„œë¶€í„°ëŠ” ê±´ë“œë¦¬ì§€ ë§ˆì„¸ìš” ---
        let allBooks = []; 
        const categoryColors = {
            'ì´ë¥˜': '#27ae60', 'ì² í•™': '#c0392b', 'ì¢…êµ': '#7f8c8d',
            'ì‚¬íšŒê³¼í•™': '#e67e22', 'ìì—°ê³¼í•™': '#795548', 'ê¸°ìˆ ê³¼í•™': '#00a8ff',
            'ì˜ˆìˆ ': '#f1c40f', 'ì–¸ì–´': '#badc58', 'ë¬¸í•™': '#192a56', 'ì—­ì‚¬': '#8e44ad', 'ê¸°íƒ€': '#bdc3c7'
        };

        function debugLog(msg, isError = false) {
            const statusDiv = document.getElementById('status');
            if (isError) {
                statusDiv.innerHTML = `<div style="color:red; font-weight:bold; background:#fff0f0; padding:20px; border-radius:10px; border:2px solid red;">
                    ğŸš¨ ì˜¤ë¥˜ ë°œìƒ!<br>${msg}
                    </div>`;
                console.error(msg);
            } else {
                statusDiv.innerText = msg;
                console.log(msg);
            }
        }

        function parseCSV(text) {
            const rows = []; let row = []; let col = ''; let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                let char = text[i]; let next = text[i+1];
                if (char === '"' && inQuotes && next === '"') { col += '"'; i++; }
                else if (char === '"') { inQuotes = !inQuotes; }
                else if (char === ',' && !inQuotes) { row.push(col); col = ''; }
                else if (char === '\n' && !inQuotes) { row.push(col); rows.push(row); row = []; col = ''; }
                else if (char !== '\r') { col += char; }
            }
            if (col || row.length > 0) { row.push(col); rows.push(row); }
            return rows;
        }

        function getCategoryFromCallNo(callNo) {
            if (!callNo) return 'ê¸°íƒ€';
            const match = callNo.match(/(\d{3})/);
            if (!match) return 'ê¸°íƒ€';
            const num = match[1]; 
            const hundreds = num.charAt(0);
            const map = { '0': 'ì´ë¥˜', '1': 'ì² í•™', '2': 'ì¢…êµ', '3': 'ì‚¬íšŒê³¼í•™', '4': 'ìì—°ê³¼í•™', '5': 'ê¸°ìˆ ê³¼í•™', '6': 'ì˜ˆìˆ ', '7': 'ì–¸ì–´', '8': 'ë¬¸í•™', '9': 'ì—­ì‚¬' };
            return map[hundreds] || 'ê¸°íƒ€';
        }

        async function loadBooks() {
            try {
                debugLog("1. êµ¬ê¸€ ì‹œíŠ¸ ì—°ê²° ì‹œë„ ì¤‘...");
                
                if (sheetCsvUrl.includes("YOUR_GOOGLE_SHEET")) {
                    throw new Error("ì½”ë“œ ìƒë‹¨ì˜ sheetCsvUrlì— ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                }
                if (sheetCsvUrl.includes("/edit")) {
                    throw new Error("ì…ë ¥í•˜ì‹  ì£¼ì†ŒëŠ” 'í¸ì§‘ìš© ì£¼ì†Œ'ì…ë‹ˆë‹¤. 'ì›¹ì— ê²Œì‹œ' > 'CSV' ì£¼ì†Œë¥¼ ë„£ì–´ì£¼ì„¸ìš”.");
                }

                const response = await fetch(sheetCsvUrl + "&t=" + new Date().getTime());
                
                if (!response.ok) {
                    throw new Error(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ (ìƒíƒœì½”ë“œ: ${response.status})`);
                }

                const csvText = await response.text();
                
                // HTML ì—ëŸ¬ í˜ì´ì§€ê°€ ì™”ëŠ”ì§€ í™•ì¸
                if (csvText.trim().startsWith("<!DOCTYPE") || csvText.includes("<html")) {
                    throw new Error("CSV ë°ì´í„°ê°€ ì•„ë‹ˆë¼ HTML í˜ì´ì§€ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. 'ì›¹ì— ê²Œì‹œ' ë§í¬ê°€ ë§ëŠ”ì§€ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
                }

                debugLog("2. ë°ì´í„° ë¶„ì„ ë° ë¶„ë¥˜ ì¤‘...");
                const data = parseCSV(csvText);

                if (data.length < 2) {
                    throw new Error("ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. êµ¬ê¸€ ì‹œíŠ¸ Aì—´(ISBN)ê³¼ Bì—´(ì œëª©)ì— ë‚´ìš©ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
                }

                allBooks = [];
                for (let i = 1; i < data.length; i++) {
                    const cols = data[i];
                    // ë°ì´í„° ì—´ ê°œìˆ˜ê°€ ë¶€ì¡±í•´ë„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
                    if (cols.length > 1) { 
                        // undefined ë°©ì§€ë¥¼ ìœ„í•œ ì•ˆì „ ì¥ì¹˜
                        const getCol = (idx) => cols[idx] ? cols[idx].trim() : '';
                        
                        const callNo = getCol(8); 
                        const autoCategory = getCategoryFromCallNo(callNo);
                        
                        allBooks.push({
                            title: getCol(1),
                            author: getCol(2),
                            pub: getCol(3),
                            desc: getCol(4),
                            img: getCol(5),
                            link: getCol(6),
                            badge: getCol(7),
                            callNo: callNo,
                            category: autoCategory
                        });
                    }
                }

                debugLog("3. í™”ë©´ ê·¸ë¦¬ê¸° ì¤‘...");
                allBooks.sort((a, b) => a.callNo.localeCompare(b.callNo));

                renderDashboard();
                createFilterButtons();
                renderBooks('ì „ì²´');

                // ì„±ê³µ ì‹œ
                document.getElementById('status').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block'; 

            } catch (e) {
                debugLog(e.message, true);
            }
        }

        // --- ë Œë”ë§ í•¨ìˆ˜ë“¤ (ì´ì „ê³¼ ë™ì¼) ---
        function renderDashboard() {
            const total = allBooks.length;
            document.getElementById('total-count').innerText = total;
            const stats = {};
            allBooks.forEach(book => { stats[book.category] = (stats[book.category] || 0) + 1; });
            const order = ['ì´ë¥˜', 'ì² í•™', 'ì¢…êµ', 'ì‚¬íšŒê³¼í•™', 'ìì—°ê³¼í•™', 'ê¸°ìˆ ê³¼í•™', 'ì˜ˆìˆ ', 'ì–¸ì–´', 'ë¬¸í•™', 'ì—­ì‚¬', 'ê¸°íƒ€'];
            const barContainer = document.getElementById('dna-bar');
            const legendContainer = document.getElementById('stat-legend');
            barContainer.innerHTML = ''; legendContainer.innerHTML = '';
            order.forEach(cat => {
                const count = stats[cat];
                if (count > 0) {
                    const percentage = (count / total) * 100;
                    const color = categoryColors[cat] || '#ccc';
                    const segment = document.createElement('div');
                    segment.className = 'dna-segment';
                    segment.style.width = '0%'; 
                    segment.style.backgroundColor = color;
                    segment.setAttribute('data-label', `${cat}: ${count}ê¶Œ (${percentage.toFixed(1)}%)`);
                    setTimeout(() => { segment.style.width = `${percentage}%`; }, 100);
                    barContainer.appendChild(segment);
                    legendContainer.innerHTML += `<div class="stat-item"><span class="stat-dot" style="background:${color}"></span>${cat} ${count}</div>`;
                }
            });
        }
        function openRandomModal() {
            if (allBooks.length === 0) return;
            const randomIndex = Math.floor(Math.random() * allBooks.length);
            const randomBook = allBooks[randomIndex];
            document.getElementById('modal-img').src = randomBook.img;
            document.getElementById('modal-title').innerText = randomBook.title;
            document.getElementById('modal-author').innerText = randomBook.author + ' | ' + randomBook.pub;
            document.getElementById('modal-link').href = randomBook.link;
            document.getElementById('randomModal').style.display = 'block';
        }
        function closeRandomModal() { document.getElementById('randomModal').style.display = 'none'; }
        window.onclick = function(event) { if (event.target == document.getElementById('randomModal')) closeRandomModal(); }
        function renderBooks(filterCategory) {
            const gallery = document.getElementById('book-gallery');
            gallery.innerHTML = ''; 
            allBooks.forEach(book => {
                if (filterCategory === 'ì „ì²´' || book.category === filterCategory) {
                    let badgeHtml = '';
                    if (book.badge === 'ì‹ ê·œ') badgeHtml = '<div class="badge badge-new">NEW</div>';
                    else if (book.badge === 'ì¶”ì²œ') badgeHtml = '<div class="badge badge-pick">PICK</div>';
                    else if (book.badge === 'ì¸ê¸°') badgeHtml = '<div class="badge badge-hot">HOT</div>';
                    let callNoHtml = book.callNo ? `<div class="call-number">${book.callNo}</div>` : '';
                    if (book.img.startsWith('http')) {
                        gallery.innerHTML += `<a href="${book.link}" target="_blank" class="book-card">${badgeHtml}<img src="${book.img}" alt="${book.title}" onerror="this.src='https://via.placeholder.com/300x450?text=No+Image'">${callNoHtml}<div class="title">${book.title}</div><div class="info">${book.author} | ${book.pub}</div><div class="description">${book.desc}</div></a>`;
                    }
                }
            });
        }
        function createFilterButtons() {
            const order = ['ì „ì²´', 'ì´ë¥˜', 'ì² í•™', 'ì¢…êµ', 'ì‚¬íšŒê³¼í•™', 'ìì—°ê³¼í•™', 'ê¸°ìˆ ê³¼í•™', 'ì˜ˆìˆ ', 'ì–¸ì–´', 'ë¬¸í•™', 'ì—­ì‚¬', 'ê¸°íƒ€'];
            const existCats = [...new Set(allBooks.map(b => b.category))];
            const finalCats = order.filter(c => c === 'ì „ì²´' || existCats.includes(c));
            const btnContainer = document.getElementById('filter-buttons');
            btnContainer.innerHTML = '';
            finalCats.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'filter-btn';
                if (cat === 'ì „ì²´') btn.classList.add('active');
                btn.innerText = cat;
                btn.onclick = () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderBooks(cat);
                };
                btnContainer.appendChild(btn);
            });
        }

        loadBooks();
    </script>
